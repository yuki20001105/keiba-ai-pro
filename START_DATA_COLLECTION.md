# 安全なデータ収集の開始手順

## 🎯 前提条件

✅ VPN（ProtonVPN等）に接続済み  
✅ test_after_vpn.py でnetkeiba.comへのアクセス成功を確認済み

---

## 📋 ステップ1: レート制限機能付きサービスの起動

### PowerShellターミナル1（サービス起動用）

```powershell
cd C:\Users\yuki2\Documents\ws\keiba-ai-pro

# レート制限機能付きスクレイピングサービスを起動
C:\Users\yuki2\Documents\ws\keiba\Scripts\python.exe scraping_service_v2.py
```

**起動メッセージの確認:**
```
================================================================================
レート制限機能付きスクレイピングサービス起動
================================================================================
最小間隔: 3.0秒
最大間隔: 7.0秒
================================================================================
INFO:     Started server process [xxxxx]
INFO:     Uvicorn running on http://0.0.0.0:8001
```

✅ このターミナルはそのまま開いたままにしておいてください

---

## 🧪 ステップ2: サービスのテスト

### PowerShellターミナル2（テスト実行用）

```powershell
cd C:\Users\yuki2\Documents\ws\keiba-ai-pro

# 安全なデータ収集テストを実行
C:\Users\yuki2\Documents\ws\keiba\Scripts\python.exe test_safe_scraping.py
```

### 期待される結果:

```
✓ サービス稼働中
✓ 成功（処理時間: 8.5秒）
  待機時間: 4.2秒
  レース名: 第69回有馬記念(G1)
  距離: 2500m
  トラック: 芝
  結果データ: 18頭
  払い戻し: 5件
```

---

## 🚀 ステップ3: Next.jsアプリからのデータ収集

### 3-1. Next.js開発サーバーの起動

```powershell
# 新しいターミナル3を開く
cd C:\Users\yuki2\Documents\ws\keiba-ai-pro
npm run dev
```

### 3-2. データ収集UIにアクセス

1. ブラウザで http://localhost:3000/data-collection を開く
2. race_idを入力（例: `202412220612`）
3. 「データ収集開始」ボタンをクリック

### 3-3. 動作確認

- ✅ 各リクエスト間に3〜7秒の待機時間が自動で入る
- ✅ レースデータが正常に取得される
- ✅ IPブロックされない

---

## ⚠️ 重要な制限事項

### レート制限（自動適用）

- **最小間隔**: 3秒
- **最大間隔**: 7秒
- **推奨**: 各リクエストはランダムに3〜7秒の間隔

### 推奨データ収集量

| 期間 | 最大リクエスト数 |
|------|----------------|
| 1時間 | 50リクエスト |
| 1日 | 100リクエスト |
| 1週間 | 500リクエスト |

### 禁止事項

❌ 短時間に大量のリクエスト  
❌ レート制限の無効化  
❌ 連続した大量データ収集（100件以上/日）

---

## 📊 サービスの監視

### リアルタイム統計の確認

```powershell
# 統計情報を取得
curl http://localhost:8001/stats
```

**出力例:**
```json
{
  "total_requests": 15,
  "uptime_seconds": 325.4,
  "average_interval_seconds": 5.2,
  "rate_limit_config": {
    "min_interval": 3.0,
    "max_interval": 7.0
  }
}
```

### ヘルスチェック

```powershell
curl http://localhost:8001/health
```

---

## 🛠️ トラブルシューティング

### エラー: "サービスが起動していません"

**原因**: scraping_service_v2.py が起動していない

**解決策**:
```powershell
C:\Users\yuki2\Documents\ws\keiba\Scripts\python.exe scraping_service_v2.py
```

### エラー: "まだ400エラーです"

**原因**: VPN接続が切れた、またはIPブロックされた

**解決策**:
1. ProtonVPN接続を確認
2. 別のVPNサーバーに接続
3. 1〜2時間待機してから再試行

### エラー: "Port 8001 already in use"

**原因**: 別のプロセスが8001番ポートを使用中

**解決策**:
```powershell
# ポートを使用しているプロセスを停止
Get-NetTCPConnection -LocalPort 8001 -ErrorAction SilentlyContinue | 
  Select-Object -ExpandProperty OwningProcess | 
  ForEach-Object { Stop-Process -Id $_ -Force }
```

### 429 Too Many Requests エラー

**原因**: netkeiba.comのレート制限に引っかかった

**解決策**:
1. すぐにデータ収集を停止
2. 最低1時間待機
3. より長い間隔（5〜10秒）で再開

---

## 📝 長期運用のベストプラクティス

### 1. スケジュール化

cron/タスクスケジューラで**1日1回**程度の自動実行:

```powershell
# 例: 毎日深夜2時に実行
# タスクスケジューラで設定
```

### 2. エラーハンドリング

- 400エラー → 即座に停止、VPN確認
- 429エラー → 1時間待機
- その他 → 5分後にリトライ（最大3回）

### 3. ログ記録

```python
# 各リクエストの結果をログファイルに記録
# 成功/失敗、race_id、タイムスタンプ
```

### 4. データベース保存

成功したデータは即座にSupabaseに保存:
- レースマスタ
- 結果データ
- 払い戻し情報

---

## 🎯 成功の指標

✅ **短期目標（1週間）**
- 毎日10〜20レースのデータ収集
- IPブロックなし
- エラー率 5%以下

✅ **中期目標（1ヶ月）**
- 累計500レース以上のデータ
- 安定した収集体制
- 自動化の実現

✅ **長期目標（3ヶ月）**
- 2000レース以上のデータ
- AI予測モデルのトレーニング開始
- 本番運用への移行

---

## 📞 次のステップ

1. ✅ **今すぐ**: test_safe_scraping.py でテスト実行
2. ✅ **成功後**: Next.jsアプリからデータ収集開始
3. ✅ **1週間後**: 収集データの品質確認
4. ✅ **1ヶ月後**: 自動化とスケジューリングの検討

---

## 🔒 セキュリティとコンプライアンス

- ✅ netkeiba.comの利用規約を遵守
- ✅ 適切なUser-Agentヘッダー
- ✅ レート制限の厳守
- ✅ 個人情報の適切な取り扱い
- ✅ データの商用利用禁止（個人利用のみ）

---

**準備完了！安全にデータ収集を開始してください。**
