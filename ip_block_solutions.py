"""
IPブロック回避のための総合ガイドと解決策
"""

# ===============================================================================
# 現在の状況
# ===============================================================================
# - requests ライブラリ: 全て 400 Bad Request
# - Selenium + Edge: 接続失敗
# - Playwright + stealth: 全て 400 Bad Request  
# - undetected-chromedriver: セッション切断
#
# → IPアドレスレベルでブロックされている可能性が非常に高い
# ===============================================================================

# ===============================================================================
# 解決策 1: プロキシサーバーの使用
# ===============================================================================

## A. 無料プロキシ（テスト用）
# - test_with_proxy.py を実行
# - 注意: 無料プロキシは不安定で遅く、多くがブロックされている

## B. 有料プロキシサービス（推奨）
# 1. Bright Data (旧Luminati)
#    - URL: https://brightdata.com/
#    - 特徴: 最も信頼性が高い、住宅用IP、日本のIPも利用可能
#    - 価格: $500/月〜
#    - Pythonコード例:
#    ```python
#    proxies = {
#        'http': 'http://username:password@brd.superproxy.io:22225',
#        'https': 'http://username:password@brd.superproxy.io:22225'
#    }
#    response = requests.get(url, proxies=proxies)
#    ```
#
# 2. Oxylabs
#    - URL: https://oxylabs.io/
#    - 特徴: データセンターIP、住宅用IP両方あり
#    - 価格: $300/月〜
#
# 3. SmartProxy
#    - URL: https://smartproxy.com/
#    - 特徴: 住宅用プロキシ、使いやすい
#    - 価格: $75/月〜
#
# 4. ProxyMesh（安価）
#    - URL: https://proxymesh.com/
#    - 価格: $10/月〜

# ===============================================================================
# 解決策 2: VPNの使用
# ===============================================================================
# VPNをPC全体に適用することで、別のIPからアクセス
#
# おすすめVPN:
# 1. NordVPN - https://nordvpn.com/
# 2. ExpressVPN - https://www.expressvpn.com/
# 3. ProtonVPN - https://protonvpn.com/（無料プランあり）
#
# 手順:
# 1. VPNをインストール
# 2. 日本のサーバーに接続（または別の国）
# 3. スクリプトを実行

# ===============================================================================
# 解決策 3: 時間を置く
# ===============================================================================
# レート制限の場合、時間経過で解除される可能性あり
# - 推奨待機時間: 6〜24時間
# - 再試行の際は、リクエスト間隔を長くする（例: 各リクエスト間に5秒待機）

# ===============================================================================
# 解決策 4: 別のネットワークから試す
# ===============================================================================
# 1. スマホのテザリング（モバイルネットワーク）
# 2. カフェやコワーキングスペースのWi-Fi
# 3. 友人宅のネットワーク
# 4. クラウドサーバー（AWS EC2, GCP Compute Engine等）

# ===============================================================================
# 解決策 5: クラウドサーバーからの実行
# ===============================================================================
# AWS、GCP、Azureなどのクラウドサーバーは別のIPアドレスを持つ
#
# AWS EC2での実行例:
# 1. EC2インスタンスを起動（東京リージョン t2.micro等）
# 2. Pythonとスクリプトをセットアップ
# 3. スクリプトを実行
# 4. 必要に応じてIPアドレスを変更（Elastic IP）

# ===============================================================================
# 解決策 6: レート制限を守った実装
# ===============================================================================
# 今後ブロックされないための対策
#
# ```python
# import time
# import random
# 
# def scrape_with_delay(urls):
#     for url in urls:
#         # リクエスト前に待機（3〜7秒のランダム間隔）
#         time.sleep(random.uniform(3, 7))
#         
#         # リクエスト実行
#         response = requests.get(url, headers=headers)
#         
#         # 429 Too Many Requestsの場合は長めに待機
#         if response.status_code == 429:
#             print("Rate limited, waiting 60 seconds...")
#             time.sleep(60)
# ```

# ===============================================================================
# 解決策 7: netkeiba.com公式APIの使用（もしあれば）
# ===============================================================================
# 公式APIがあれば、それを使用するのが最も安全
# - netkeiba.comのドキュメントを確認
# - 利用規約を確認

# ===============================================================================
# 解決策 8: Rotating Proxy（プロキシローテーション）
# ===============================================================================
# 複数のプロキシをローテーションして使用
#
# ```python
# from itertools import cycle
# 
# proxy_pool = [proxy1, proxy2, proxy3, ...]
# proxy_cycle = cycle(proxy_pool)
# 
# def get_with_rotating_proxy(url):
#     proxy = next(proxy_cycle)
#     return requests.get(url, proxies=proxy)
# ```

# ===============================================================================
# 推奨アプローチ（優先順位）
# ===============================================================================
# 1. [短期] 時間を置く（6〜24時間）→ 無料
# 2. [短期] VPNを使う（ProtonVPN無料版など）→ 無料〜$10/月
# 3. [短期] スマホのテザリングで試す → 無料
# 4. [中期] 有料プロキシサービス（SmartProxy等）→ $75/月〜
# 5. [長期] クラウドサーバー + プロキシローテーション → 安定運用

# ===============================================================================
# 次のステップ
# ===============================================================================
print("""
===========================================
IPブロック回避の次のステップ
===========================================

【今すぐできること（無料）】
1. 6〜24時間待ってから再試行
2. スマホのテザリングで試す
3. ProtonVPN（無料版）をインストールして試す

【有料だが確実な方法】
4. test_with_proxy.py を修正して有料プロキシで試す
   - SmartProxy: $75/月〜
   - Bright Data: $500/月〜

【テスト実行】
- プロキシテスト: python test_with_proxy.py
- VPN接続後に: python test_actual_working_raceid.py

【長期的な解決】
- レート制限を守った実装（各リクエスト間に3〜7秒待機）
- プロキシローテーション
- エラーハンドリングとリトライロジック
""")
