'use client'

import { useState, useEffect } from 'react'
import { supabase } from '@/lib/supabase'
import { useRouter } from 'next/navigation'

export default function DataCollectionPage() {
  const router = useRouter()
  const [loading, setLoading] = useState(false)
  const [userId, setUserId] = useState<string | null>(null)
  const [ultimateMode, setUltimateMode] = useState(false)
  const [includeDetails, setIncludeDetails] = useState(false) // é«˜é€ŸåŒ–: è©³ç´°å–å¾—ã‚ªãƒ—ã‚·ãƒ§ãƒ³

  // å˜ä¸€ãƒ¬ãƒ¼ã‚¹IDå–å¾—
  const [raceId, setRaceId] = useState('')
  const [scrapeResult, setScrapeResult] = useState<any>(null)

  // æœŸé–“æŒ‡å®šç”¨
  const [startYear, setStartYear] = useState(2024)
  const [startMonth, setStartMonth] = useState(1)
  const [endYear, setEndYear] = useState(new Date().getFullYear())
  const [endMonth, setEndMonth] = useState(new Date().getMonth() + 1)
  const [bulkProgress, setBulkProgress] = useState<string>('')
  const [bulkMode, setBulkMode] = useState(false)
  const [bulkStats, setBulkStats] = useState({ 
    totalMonths: 0, 
    completedMonths: 0, 
    completedRaces: 0 
  })

  // ãƒ‡ãƒ¼ã‚¿çµ±è¨ˆã¨è¡¨ç¤º
  const [dataStats, setDataStats] = useState({ totalRaces: 0, totalResults: 0, latestDate: '', dbPath: '' })
  const [showCollectedData, setShowCollectedData] = useState(false)
  const [collectedRaces, setCollectedRaces] = useState<any[]>([])
  const [selectedRaceDetail, setSelectedRaceDetail] = useState<any>(null)


  useEffect(() => {
    const getUser = async () => {
      const { data: { user } } = await supabase.auth.getUser()
      if (!user) {
        router.push('/auth/login')
        return
      }
      setUserId(user.id)
      loadStats()
    }
    getUser()
  }, [router, ultimateMode])

  const loadStats = async () => {
    try {
      const dbPath = ultimateMode ? 'keiba_ultimate.db' : 'keiba.db'
      const response = await fetch(`http://localhost:8000/api/data_stats?ultimate=${ultimateMode}`)
      if (response.ok) {
        const data = await response.json()
        setDataStats({ ...data, dbPath })
      }
    } catch (error) {
      console.error('çµ±è¨ˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error)
    }
  }

  const fetchCollectedData = async (userId: string) => {
    try {
      const { data, error } = await supabase
        .from('collected_races')
        .select('*')
        .eq('user_id', userId)
        .order('created_at', { ascending: false })
        .limit(50)
      
      if (error) throw error
      setCollectedRaces(data || [])
    } catch (error) {
      console.error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error)
    }
  }

  const fetchRaceDetail = async (raceId: string) => {
    try {
      const { data, error } = await supabase
        .from('race_results')
        .select('*')
        .eq('race_id', raceId)
        .order('finish_position', { ascending: true })
      
      if (error) throw error
      setSelectedRaceDetail({ raceId, results: data || [] })
    } catch (error) {
      console.error('ãƒ¬ãƒ¼ã‚¹è©³ç´°å–å¾—ã‚¨ãƒ©ãƒ¼:', error)
    }
  }

  const handleScrapeRace = async () => {
    if (!raceId.trim()) {
      alert('ãƒ¬ãƒ¼ã‚¹IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„')
      return
    }

    setLoading(true)
    setScrapeResult(null)
    try {
      const port = ultimateMode ? 8001 : 8000
      const endpoint = ultimateMode ? '/scrape/ultimate' : `/scrape/${raceId}`
      
      let response
      if (ultimateMode) {
        // Ultimateç‰ˆã¯POSTã§include_detailsã‚’é€ä¿¡
        response = await fetch(`http://localhost:${port}${endpoint}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            race_id: raceId,
            include_details: includeDetails
          })
        })
      } else {
        response = await fetch(`http://localhost:${port}${endpoint}`)
      }
      
      if (!response.ok) throw new Error(`HTTP ${response.status}`)
      
      const data = await response.json()
      setScrapeResult(data)
      alert(`ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†ï¼${includeDetails ? 'ï¼ˆè©³ç´°æƒ…å ±å«ã‚€ï¼‰' : 'ï¼ˆé«˜é€Ÿãƒ¢ãƒ¼ãƒ‰ï¼‰'}`)
      loadStats()
    } catch (error: any) {
      alert(`å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`)
    } finally {
      setLoading(false)
    }
  }

  // æœŸé–“æŒ‡å®šã§ä¸€æ‹¬å–å¾—
      <div className="max-w-6xl mx-auto">
        {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
        <div className="mb-8 text-center">
          <h1 className="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-400 mb-2">
            ğŸ“Š ãƒ‡ãƒ¼ã‚¿å–å¾—
          </h1>
          <p className="text-gray-400">netkeibaã‹ã‚‰ç«¶é¦¬ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°</p>
        </div>

        {/* Ultimateç‰ˆåˆ‡ã‚Šæ›¿ãˆ */}
        <div className="mb-6 p-6 bg-slate-800/50 backdrop-blur-sm rounded-xl border border-blue-500/30">
          <div className="flex items-center justify-between">
            <div>
              <h2 className="text-xl font-bold text-blue-400 mb-1">Ultimateç‰ˆãƒ¢ãƒ¼ãƒ‰</h2>
              <p className="text-gray-400 text-sm">90åˆ—ä»¥ä¸Šã®è©³ç´°ç‰¹å¾´é‡ã‚’å–å¾—ï¼ˆé€šå¸¸: 60åˆ—ï¼‰</p>
            </div>
            <button
              onClick={() => setUltimateMode(!ultimateMode)}
              className={`px-6 py-3 rounded-lg font-semibold transition-all ${
                ultimateMode
                  ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-lg shadow-purple-500/50'
                  : 'bg-slate-700 text-gray-300 hover:bg-slate-600'
              }`}
            >
              {ultimateMode ? 'âœ¨ Ultimateç‰ˆ ON' : 'Ultimateç‰ˆ OFF'}
            </button>
          </div>
          {ultimateMode && (
            <div className="mt-4 p-4 bg-purple-900/20 rounded-lg border border-purple-500/30">
              <p className="text-purple-300 text-sm">
                ğŸš€ Ultimateç‰ˆãƒ¢ãƒ¼ãƒ‰: ãƒ©ãƒƒãƒ—ã‚¿ã‚¤ãƒ è©³ç´°ã€è¡€çµ±çµ±è¨ˆã€é¨æ‰‹ãƒ»èª¿æ•™å¸«IDã€éå»æˆç¸¾è©³ç´°ãªã©ã‚’è¿½åŠ å–å¾—ã—ã¾ã™
              </p>
            </div>
          )}
        </div>

        {/* ãƒ‡ãƒ¼ã‚¿çµ±è¨ˆ */}
        <div className="mb-6 p-6 bg-slate-800/50 backdrop-blur-sm rounded-xl border border-blue-500/30">
          <h2 className="text-xl font-bold text-blue-400 mb-4">ğŸ“ˆ ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿</h2>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div className="p-4 bg-slate-700/50 rounded-lg">
              <p className="text-gray-400 text-sm">ãƒ¬ãƒ¼ã‚¹æ•°</p>
              <p className="text-3xl font-bold text-white">{dataStats.totalRaces}</p>
            </div>
            <div className="p-4 bg-slate-700/50 rounded-lg">
              <p className="text-gray-400 text-sm">å‡ºèµ°é¦¬æ•°</p>
              <p className="text-3xl font-bold text-white">{dataStats.totalHorses}</p>
            </div>
            <div className="p-4 bg-slate-700/50 rounded-lg">
              <p className="text-gray-400 text-sm">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</p>
              <p className="text-sm font-bold text-cyan-400">{dataStats.dbPath}</p>
            </div>
          </div>
        </div>

        {/* å˜ä¸€ãƒ¬ãƒ¼ã‚¹IDå–å¾— */}
        <div className="mb-6 p-6 bg-slate-800/50 backdrop-blur-sm rounded-xl border border-blue-500/30">
          <h2 className="text-xl font-bold text-blue-400 mb-4">ğŸ¯ å˜ä¸€ãƒ¬ãƒ¼ã‚¹å–å¾—</h2>
          
          {/* Ultimateç‰ˆã®è©³ç´°å–å¾—ã‚ªãƒ—ã‚·ãƒ§ãƒ³ */}
          {ultimateMode && (
            <div className="mb-4 p-3 bg-slate-700/30 rounded-lg border border-cyan-500/30">
              <label className="flex items-center gap-3 cursor-pointer">
                <input
                  type="checkbox"
                  checked={includeDetails}
                  onChange={(e) => setIncludeDetails(e.target.checked)}
                  className="w-5 h-5 text-cyan-500 bg-slate-700 border-cyan-500 rounded focus:ring-cyan-500"
                />
                <div>
                  <span className="text-white font-semibold">è©³ç´°æƒ…å ±ã‚’å–å¾—</span>
                  <p className="text-gray-400 text-xs mt-1">
                    {includeDetails 
                      ? 'ğŸ¢ å®Œå…¨ãƒ¢ãƒ¼ãƒ‰: é¦¬è©³ç´°ãƒ»é¨æ‰‹çµ±è¨ˆãƒ»å‰èµ°ãƒ‡ãƒ¼ã‚¿ãªã©å…¨94åˆ—ï¼ˆç´„60-120ç§’ï¼‰' 
                      : 'ğŸš€ é«˜é€Ÿãƒ¢ãƒ¼ãƒ‰: IDãƒ»é‡é‡ãªã©å¿…é ˆé …ç›®ã®ã¿27åˆ—ï¼ˆç´„15-30ç§’ï¼‰'}
                  </p>
                </div>
              </label>
            </div>
          )}
          
          <div className="flex gap-4">
            <input
              type="text"
              placeholder="ãƒ¬ãƒ¼ã‚¹ID (ä¾‹: 202406010101)"
              value={raceId}
              onChange={(e) => setRaceId(e.target.value)}
              className="flex-1 px-4 py-3 bg-slate-700/50 border border-blue-500/30 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-blue-400"
            />
            <button
              onClick={handleScrapeRace}
              disabled={loading}
              className="px-8 py-3 bg-gradient-to-r from-blue-600 to-cyan-600 text-white font-semibold rounded-lg hover:from-blue-500 hover:to-cyan-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-lg shadow-blue-500/20"
            >
              {loading ? 'å–å¾—ä¸­...' : 'å–å¾—é–‹å§‹'}
            </button>
          </div>
          {scrapeResult && (
            <div className="mt-4 p-4 bg-green-900/20 rounded-lg border border-green-500/30">
              <p className="text-green-300">âœ… å–å¾—æˆåŠŸ: {scrapeResult.horses_count || 0}é ­</p>
            </div>
          )}
        </div>

        {/* æœŸé–“æŒ‡å®šä¸€æ‹¬å–å¾— */}
        <div className="p-6 bg-slate-800/50 backdrop-blur-sm rounded-xl border border-blue-500/30">
          <h2 className="text-xl font-bold text-blue-400 mb-4">ğŸ“… æœŸé–“æŒ‡å®šä¸€æ‹¬å–å¾—</h2>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
            <div>
              <label className="block text-gray-400 text-sm mb-2">é–‹å§‹å¹´</label>
              <input
                type="number"
                value={startYear}
                onChange={(e) => setStartYear(parseInt(e.target.value))}
                className="w-full px-4 py-2 bg-slate-700/50 border border-blue-500/30 rounded-lg text-white focus:outline-none focus:border-blue-400"
              />
            </div>
            <div>
              <label className="block text-gray-400 text-sm mb-2">é–‹å§‹æœˆ</label>
              <input
                type="number"
                min="1"
                max="12"
                value={startMonth}
                onChange={(e) => setStartMonth(parseInt(e.target.value))}
                className="w-full px-4 py-2 bg-slate-700/50 border border-blue-500/30 rounded-lg text-white focus:outline-none focus:border-blue-400"
              />
            </div>
            <div>
              <label className="block text-gray-400 text-sm mb-2">çµ‚äº†å¹´</label>
              <input
                type="number"
                value={endYear}
                onChange={(e) => setEndYear(parseInt(e.target.value))}
                className="w-full px-4 py-2 bg-slate-700/50 border border-blue-500/30 rounded-lg text-white focus:outline-none focus:border-blue-400"
              />
            </div>
            <div>
              <label className="block text-gray-400 text-sm mb-2">çµ‚äº†æœˆ</label>
              <input
                type="number"
                min="1"
                max="12"
                value={endMonth}
                onChange={(e) => setEndMonth(parseInt(e.target.value))}
                className="w-full px-4 py-2 bg-slate-700/50 border border-blue-500/30 rounded-lg text-white focus:outline-none focus:border-blue-400"
              />
            </div>
          </div>
          <button
            onClick={handleBulkScrape}
            disabled={loading}
            className="w-full px-8 py-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold rounded-lg hover:from-purple-500 hover:to-pink-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-lg shadow-purple-500/20"
          >
            {loading ? 'ä¸€æ‹¬å–å¾—ä¸­...' : 'ğŸš€ ä¸€æ‹¬å–å¾—é–‹å§‹'}
          </button>
          
          {bulkProgress && (
            <div className="mt-4 p-4 bg-blue-900/20 rounded-lg border border-blue-500/30">
              <p className="text-blue-300 mb-2">{bulkProgress}</p>
              <div className="grid grid-cols-3 gap-4 text-center">
                <div>
                  <p className="text-gray-400 text-xs">åˆè¨ˆ</p>
                  <p className="text-white font-bold">{bulkStats.total}</p>
                </div>
                <div>
                  <p className="text-gray-400 text-xs">å®Œäº†</p>
                  <p className="text-green-400 font-bold">{bulkStats.completed}</p>
                </div>
                <div>
                  <p className="text-gray-400 text-xs">å¤±æ•—</p>
                  <p className="text-red-400 font-bold">{bulkStats.failed}</p>
                </div>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  )
}

  // å–å¾—æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
  const fetchCollectedData = async (uid: string) => {
    try {
      // ãƒ¬ãƒ¼ã‚¹æƒ…å ±ã‚’å–å¾—
      const { data: racesData, error: racesError } = await supabase
        .from('races')
        .select('*')
        .eq('user_id', uid)
        .order('created_at', { ascending: false })
        .limit(50)

      if (racesError) throw racesError

      setCollectedRaces(racesData || [])

      // çµ±è¨ˆæƒ…å ±ã‚’å–å¾—
      const { count: raceCount } = await supabase
        .from('races')
        .select('*', { count: 'exact', head: true })
        .eq('user_id', uid)

      const { count: resultCount } = await supabase
        .from('results')
        .select('*', { count: 'exact', head: true })
        .eq('user_id', uid)

      const latestRace = racesData && racesData.length > 0 ? racesData[0].created_at : ''

      setDataStats({
        totalRaces: raceCount || 0,
        totalResults: resultCount || 0,
        latestDate: latestRace
      })
    } catch (error) {
      console.error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error)
    }
  }

  // ãƒ¬ãƒ¼ã‚¹è©³ç´°ã‚’å–å¾—
  const fetchRaceDetail = async (raceId: string) => {
    try {
      const { data: resultsData, error } = await supabase
        .from('results')
        .select('*')
        .eq('race_id', raceId)
        .order('finish_position', { ascending: true })

      if (error) throw error

      setSelectedRaceDetail({
        raceId,
        results: resultsData || []
      })
    } catch (error) {
      console.error('ãƒ¬ãƒ¼ã‚¹è©³ç´°å–å¾—ã‚¨ãƒ©ãƒ¼:', error)
    }
  }

  // æœŸé–“æŒ‡å®šã§ä¸€æ‹¬å–å¾—
  const bulkScrapeByPeriod = async () => {
    if (!userId) {
      alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“')
      return
    }

    // æœŸé–“ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
    const startDate = new Date(startYear, startMonth - 1)
    const endDate = new Date(endYear, endMonth - 1)
    
    if (startDate > endDate) {
      alert('é–‹å§‹å¹´æœˆãŒçµ‚äº†å¹´æœˆã‚ˆã‚Šå¾Œã«ãªã£ã¦ã„ã¾ã™')
      return
    }

    // æœˆæ•°ã‚’è¨ˆç®—
    const totalMonths = (endYear - startYear) * 12 + (endMonth - startMonth) + 1

    const confirmMsg = `${startYear}å¹´${startMonth}æœˆ ï½ ${endYear}å¹´${endMonth}æœˆã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ‹¬å–å¾—ã—ã¾ã™ã€‚\n\nå¯¾è±¡æœŸé–“: ${totalMonths}ãƒ¶æœˆ\nâ€»å¤§é‡ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã¨ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚\n\nç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ`
    if (!confirm(confirmMsg)) return

    setLoading(true)
    setBulkMode(true)
    setBulkProgress('é–‹å§‹æº–å‚™ä¸­...')
    setBulkStats({ totalRaces: 0, completedRaces: 0, totalMonths, completedMonths: 0 })

    let totalRacesScraped = 0
    let currentYear = startYear
    let currentMonth = startMonth
    let completedMonthsCount = 0

    try {
      while (currentYear < endYear || (currentYear === endYear && currentMonth <= endMonth)) {
        setBulkProgress(`${currentYear}å¹´${currentMonth}æœˆ ã®é–‹å‚¬æ—¥ã‚’å–å¾—ä¸­...`)
        
        // 1. é–‹å‚¬æ—¥å–å¾—
        const calendarRes = await fetch(`/api/netkeiba/calendar?year=${currentYear}&month=${currentMonth}`)
        const calendarData = await calendarRes.json()
        
        if (calendarData.error) {
          console.error(`${currentYear}/${currentMonth} ã®é–‹å‚¬æ—¥å–å¾—å¤±æ•—:`, calendarData.error)
        } else {
          const datesInMonth = calendarData.dates || []
          
          if (datesInMonth.length > 0) {
            setBulkProgress(`${currentYear}å¹´${currentMonth}æœˆ: ${datesInMonth.length}æ—¥ã®é–‹å‚¬æ—¥ã‚’ç™ºè¦‹`)
            
            // 2. å„é–‹å‚¬æ—¥ã«ã¤ã„ã¦ã€race_list.htmlã‹ã‚‰å®Ÿéš›ã®race_idã‚’å–å¾—
            for (const date of datesInMonth) {
              setBulkProgress(`${date} ã®ãƒ¬ãƒ¼ã‚¹ä¸€è¦§ã‚’å–å¾—ä¸­...`)
              
              const dateStr = date.replace(/-/g, '')
              
              // race_list.htmlã‹ã‚‰ãã®æ—¥ã®race_idä¸€è¦§ã‚’å–å¾—
              try {
                const raceListRes = await fetch('http://localhost:8001/race_list', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ kaisai_date: dateStr }),
                })
                
                if (!raceListRes.ok) {
                  setBulkProgress(`${date}: ãƒ¬ãƒ¼ã‚¹ä¸€è¦§å–å¾—å¤±æ•—`)
                  continue
                }
                
                const raceListData = await raceListRes.json()
                
                if (!raceListData.success || !raceListData.race_ids || raceListData.race_ids.length === 0) {
                  setBulkProgress(`${date}: é–‹å‚¬ãªã—`)
                  continue
                }
                
                const raceIds = raceListData.race_ids
                setBulkProgress(`${date}: ${raceIds.length}ãƒ¬ãƒ¼ã‚¹ç™ºè¦‹`)
                
                // å„race_idã«ã¤ã„ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                for (let i = 0; i < raceIds.length; i++) {
                  const raceId = raceIds[i]
                  
                  try {
                    const scrapeRes = await fetch('/api/netkeiba/race', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ raceId, userId }),
                    })
                    const scrapeData = await scrapeRes.json()
                    
                    if (scrapeData.success) {
                      totalRacesScraped++
                      setBulkStats(prev => ({ ...prev, completedRaces: totalRacesScraped }))
                      setBulkProgress(`âœ… [${totalRacesScraped}ä»¶ç›®] ${date} ${raceId} å–å¾—å®Œäº†`)
                      
                      // æˆåŠŸæ™‚ã®ã¿3ç§’å¾…æ©Ÿ
                      await new Promise(resolve => setTimeout(resolve, 3000))
                    } else {
                      setBulkProgress(`âš  ${date} ${raceId}: ${scrapeData.error || 'å–å¾—å¤±æ•—'}`)
                    }
                  } catch (error) {
                    console.error(`ãƒ¬ãƒ¼ã‚¹ ${raceId} ã‚¨ãƒ©ãƒ¼:`, error)
                  }
                }
                
                setBulkProgress(`${date}: ${raceIds.length}ãƒ¬ãƒ¼ã‚¹å‡¦ç†å®Œäº†`)
                
              } catch (error) {
                console.error(`${date} ãƒ¬ãƒ¼ã‚¹ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:`, error)
                setBulkProgress(`${date}: ã‚¨ãƒ©ãƒ¼`)
              }
            }
          } else {
            setBulkProgress(`${currentYear}å¹´${currentMonth}æœˆ: é–‹å‚¬æ—¥ãªã—`)
          }
        }
        
        // æœˆå®Œäº†
        completedMonthsCount++
        setBulkStats(prev => ({ ...prev, completedMonths: completedMonthsCount }))
        
        // æ¬¡ã®æœˆã¸
        currentMonth++
        if (currentMonth > 12) {
          currentMonth = 1
          currentYear++
        }
        
        // æœˆã®é–“ã«å°‘ã—å¾…æ©Ÿ
        await new Promise(resolve => setTimeout(resolve, 2000))
      }
      
      setBulkProgress(`âœ… å®Œäº†ï¼åˆè¨ˆ ${totalRacesScraped} ãƒ¬ãƒ¼ã‚¹ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸ`)
      alert(`ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†ï¼\n\nåˆè¨ˆ ${totalRacesScraped} ãƒ¬ãƒ¼ã‚¹ã‚’å–å¾—ã—ã¾ã—ãŸ`)
      
      // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
      if (userId) {
        fetchCollectedData(userId)
      }
      
    } catch (error) {
      console.error('ä¸€æ‹¬å–å¾—ã‚¨ãƒ©ãƒ¼:', error)
      alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error)
    } finally {
      setLoading(false)
      setBulkMode(false)
    }
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50">
      <header className="bg-white/80 backdrop-blur-md shadow-sm sticky top-0 z-50">
        <div className="container mx-auto px-4 py-4 flex justify-between items-center">
          <h1 className="text-2xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">
            ğŸ“¥ ãƒ‡ãƒ¼ã‚¿å–å¾—
          </h1>
          <a href="/dashboard" className="text-indigo-600 hover:text-indigo-700 font-medium transition flex items-center">
            â† ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
          </a>
        </div>
      </header>

      <main className="container mx-auto px-4 py-8">
        {/* æœŸé–“æŒ‡å®šä¸€æ‹¬å–å¾— */}
        <div className="bg-gradient-to-r from-green-50 to-emerald-50 p-8 rounded-2xl shadow-xl mb-6 border-2 border-green-200">
          <h2 className="text-2xl font-bold mb-6 text-gray-800 flex items-center">
            <span className="bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-full w-10 h-10 flex items-center justify-center mr-3 font-extrabold">ğŸ¯</span>
            æœŸé–“æŒ‡å®šã§ä¸€æ‹¬å–å¾—ï¼ˆå­¦ç¿’ç”¨ãƒ‡ãƒ¼ã‚¿åé›†ï¼‰
          </h2>
          
          <div className="mb-6 bg-white/70 p-4 rounded-lg border border-green-300">
            <p className="text-sm text-gray-700 mb-2">
              ğŸ’¡ <strong>å­¦ç¿’ç”¨ãƒ‡ãƒ¼ã‚¿ã®åŠ¹ç‡çš„ãªåé›†æ–¹æ³•</strong>
            </p>
            <p className="text-sm text-gray-600">
              é–‹å§‹å¹´æœˆã‹ã‚‰çµ‚äº†å¹´æœˆã¾ã§ã®å…¨ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•çš„ã«å–å¾—ã—ã¾ã™ã€‚<br />
              å¤§é‡ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã«ã¯æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ãŒã€ãƒ¢ãƒ‡ãƒ«å­¦ç¿’ã«å¿…è¦ãªååˆ†ãªãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºä¿ã§ãã¾ã™ã€‚
            </p>
          </div>

          <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">é–‹å§‹å¹´</label>
              <input
                type="number"
                value={startYear}
                onChange={(e) => setStartYear(parseInt(e.target.value))}
                min={2000}
                max={new Date().getFullYear()}
                className="w-full border-2 border-gray-200 rounded-lg px-4 py-3 focus:border-green-500 focus:ring focus:ring-green-200 transition text-gray-900 font-medium"
              />
            </div>
            
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">é–‹å§‹æœˆ</label>
              <select
                value={startMonth}
                onChange={(e) => setStartMonth(parseInt(e.target.value))}
                className="w-full border-2 border-gray-200 rounded-lg px-4 py-3 focus:border-green-500 focus:ring focus:ring-green-200 transition text-gray-900 font-medium"
              >
                {Array.from({ length: 12 }, (_, i) => i + 1).map(m => (
                  <option key={m} value={m}>{m}æœˆ</option>
                ))}
              </select>
            </div>
            
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">çµ‚äº†å¹´</label>
              <input
                type="number"
                value={endYear}
                onChange={(e) => setEndYear(parseInt(e.target.value))}
                min={2000}
                max={new Date().getFullYear()}
                className="w-full border-2 border-gray-200 rounded-lg px-4 py-3 focus:border-green-500 focus:ring focus:ring-green-200 transition text-gray-900 font-medium"
              />
            </div>
            
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">çµ‚äº†æœˆ</label>
              <select
                value={endMonth}
                onChange={(e) => setEndMonth(parseInt(e.target.value))}
                className="w-full border-2 border-gray-200 rounded-lg px-4 py-3 focus:border-green-500 focus:ring focus:ring-green-200 transition text-gray-900 font-medium"
              >
                {Array.from({ length: 12 }, (_, i) => i + 1).map(m => (
                  <option key={m} value={m}>{m}æœˆ</option>
                ))}
              </select>
            </div>
          </div>

          <div className="mb-6 bg-yellow-50 p-4 rounded-lg border border-yellow-300">
            <p className="text-sm text-gray-700">
              ğŸ“Š <strong>å–å¾—æœŸé–“:</strong> {startYear}å¹´{startMonth}æœˆ ï½ {endYear}å¹´{endMonth}æœˆ
            </p>
            <p className="text-sm text-gray-600 mt-2">
              âš ï¸ æœŸé–“ãŒé•·ã„ã»ã©å–å¾—æ™‚é–“ãŒé•·ããªã‚Šã¾ã™ï¼ˆ1ãƒ¶æœˆã‚ãŸã‚Šç´„20-50ãƒ¬ãƒ¼ã‚¹ã€1ãƒ¬ãƒ¼ã‚¹3ç§’ï¼‰
            </p>
          </div>

          {bulkMode && bulkProgress && (
            <div className="mb-6 bg-white p-6 rounded-lg border-2 border-green-400 animate-fade-in">
              <div className="flex items-center mb-4">
                <div className="animate-spin mr-3 text-2xl">ğŸ”„</div>
                <h3 className="font-bold text-lg text-gray-800">å–å¾—ä¸­...</h3>
              </div>

              {/* æœˆåˆ¥é€²æ—ãƒãƒ¼ */}
              <div className="mb-4">
                <div className="flex justify-between text-sm mb-2 font-semibold text-gray-700">
                  <span>æœˆåˆ¥é€²æ—</span>
                  <span className="text-green-600">{bulkStats.completedMonths} / {bulkStats.totalMonths} ãƒ¶æœˆ</span>
                </div>
                <div className="w-full bg-gray-200 rounded-full h-6 overflow-hidden">
                  <div
                    className="bg-gradient-to-r from-green-500 via-emerald-500 to-teal-500 h-6 rounded-full transition-all duration-500 flex items-center justify-center text-white text-xs font-bold"
                    style={{ width: `${bulkStats.totalMonths > 0 ? (bulkStats.completedMonths / bulkStats.totalMonths) * 100 : 0}%` }}
                  >
                    {bulkStats.totalMonths > 0 ? Math.round((bulkStats.completedMonths / bulkStats.totalMonths) * 100) : 0}%
                  </div>
                </div>
              </div>

              {/* ãƒ¬ãƒ¼ã‚¹å–å¾—æ•° */}
              <div className="mb-4 bg-gradient-to-r from-green-50 to-emerald-50 p-4 rounded-lg border border-green-200">
                <div className="flex justify-between items-center">
                  <span className="text-sm font-semibold text-gray-700">å–å¾—å®Œäº†ãƒ¬ãƒ¼ã‚¹æ•°</span>
                  <span className="text-3xl font-extrabold bg-gradient-to-r from-green-600 to-emerald-600 bg-clip-text text-transparent">
                    {bulkStats.completedRaces}
                  </span>
                </div>
              </div>

              {/* è©³ç´°ãƒ­ã‚° */}
              <div className="bg-gray-900 p-4 rounded-lg font-mono text-sm text-green-400 max-h-40 overflow-y-auto">
                {bulkProgress}
              </div>
            </div>
          )}

          <button
            onClick={bulkScrapeByPeriod}
            disabled={loading}
            className="w-full bg-gradient-to-r from-green-600 to-emerald-600 text-white px-8 py-5 rounded-2xl text-xl font-bold hover:shadow-2xl hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300"
          >
            {loading ? 'ğŸ”„ ä¸€æ‹¬å–å¾—ä¸­... ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„' : 'ğŸš€ æœŸé–“æŒ‡å®šã§ä¸€æ‹¬å–å¾—é–‹å§‹'}
          </button>
        </div>



        {/* å–å¾—æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ç¢ºèª */}
        <div className="bg-white/80 backdrop-blur-sm p-8 rounded-2xl shadow-xl border border-blue-100">
          <div className="flex justify-between items-center mb-6">
            <h2 className="text-2xl font-bold text-gray-800 flex items-center">
              <span className="bg-gradient-to-r from-blue-600 to-cyan-600 text-white rounded-full w-10 h-10 flex items-center justify-center mr-3 font-extrabold">ğŸ“Š</span>
              å–å¾—æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿
            </h2>
            <button
              onClick={() => setShowCollectedData(!showCollectedData)}
              className="bg-gradient-to-r from-blue-600 to-cyan-600 text-white px-6 py-3 rounded-xl font-bold hover:shadow-lg hover:scale-105 transition-all duration-300"
            >
              {showCollectedData ? 'ğŸ“ é–‰ã˜ã‚‹' : 'ğŸ“‚ ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º'}
            </button>
          </div>

          {/* çµ±è¨ˆæƒ…å ± */}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div className="bg-gradient-to-br from-blue-50 to-cyan-50 p-6 rounded-xl border-2 border-blue-200">
              <div className="text-sm text-gray-600 mb-2">ç·ãƒ¬ãƒ¼ã‚¹æ•°</div>
              <div className="text-4xl font-extrabold bg-gradient-to-r from-blue-600 to-cyan-600 bg-clip-text text-transparent">
                {dataStats.totalRaces}
              </div>
            </div>
            <div className="bg-gradient-to-br from-purple-50 to-pink-50 p-6 rounded-xl border-2 border-purple-200">
              <div className="text-sm text-gray-600 mb-2">ç·å‡ºèµ°é¦¬æ•°</div>
              <div className="text-4xl font-extrabold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                {dataStats.totalResults}
              </div>
            </div>
            <div className="bg-gradient-to-br from-green-50 to-emerald-50 p-6 rounded-xl border-2 border-green-200">
              <div className="text-sm text-gray-600 mb-2">æœ€çµ‚å–å¾—æ—¥æ™‚</div>
              <div className="text-lg font-bold text-gray-700">
                {dataStats.latestDate ? new Date(dataStats.latestDate).toLocaleString('ja-JP') : 'æœªå–å¾—'}
              </div>
            </div>
          </div>

          {/* ãƒ¬ãƒ¼ã‚¹ä¸€è¦§ */}
          {showCollectedData && (
            <div className="animate-fade-in">
              <div className="flex justify-between items-center mb-4">
                <h3 className="font-bold text-lg text-gray-800">
                  æœ€è¿‘å–å¾—ã—ãŸãƒ¬ãƒ¼ã‚¹ <span className="text-blue-600">(æœ€æ–°50ä»¶)</span>
                </h3>
                <button
                  onClick={() => userId && fetchCollectedData(userId)}
                  className="text-sm bg-blue-100 text-blue-700 px-4 py-2 rounded-lg font-semibold hover:bg-blue-200 transition"
                >
                  ğŸ”„ æ›´æ–°
                </button>
              </div>

              <div className="space-y-3 max-h-[600px] overflow-y-auto">
                {collectedRaces.map(race => (
                  <div
                    key={race.race_id}
                    className="bg-white p-5 border-2 border-gray-200 rounded-xl hover:border-blue-300 hover:shadow-md transition-all duration-300"
                  >
                    <div className="flex justify-between items-start mb-3">
                      <div className="flex-1">
                        <div className="font-bold text-gray-800 text-xl mb-2">
                          {race.race_name}
                        </div>
                        <div className="flex flex-wrap gap-3 text-sm text-gray-600">
                          <span className="bg-blue-100 px-3 py-1 rounded-full">ğŸŸï¸ {race.venue}</span>
                          <span className="bg-green-100 px-3 py-1 rounded-full">ğŸ“ {race.distance}m</span>
                          <span className="bg-purple-100 px-3 py-1 rounded-full">ğŸŒ± {race.track_type}</span>
                          <span className="bg-yellow-100 px-3 py-1 rounded-full">â˜€ï¸ {race.weather}</span>
                          <span className="bg-orange-100 px-3 py-1 rounded-full">ğŸ‡ {race.field_condition}</span>
                        </div>
                      </div>
                      <button
                        onClick={() => fetchRaceDetail(race.race_id)}
                        className="ml-4 bg-gradient-to-r from-blue-500 to-cyan-500 text-white px-4 py-2 rounded-lg font-semibold hover:shadow-lg transition-all duration-300"
                      >
                        ğŸ“‹ è©³ç´°
                      </button>
                    </div>
                    <div className="text-xs text-gray-500 mt-2">
                      ğŸ†” {race.race_id} | ğŸ“… {new Date(race.created_at).toLocaleString('ja-JP')}
                    </div>
                  </div>
                ))}

                {collectedRaces.length === 0 && (
                  <div className="text-center py-12 text-gray-500">
                    <div className="text-6xl mb-4">ğŸ“­</div>
                    <p className="text-lg font-semibold">ãƒ‡ãƒ¼ã‚¿ãŒã¾ã å–å¾—ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                    <p className="text-sm mt-2">ä¸Šè¨˜ã®æ©Ÿèƒ½ã‚’ä½¿ã£ã¦ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ãã ã•ã„</p>
                  </div>
                )}
              </div>
            </div>
          )}
        </div>

        {/* ãƒ¬ãƒ¼ã‚¹è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« */}
        {selectedRaceDetail && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={() => setSelectedRaceDetail(null)}>
            <div className="bg-white rounded-2xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-hidden" onClick={(e) => e.stopPropagation()}>
              <div className="bg-gradient-to-r from-blue-600 to-cyan-600 text-white p-6">
                <div className="flex justify-between items-center">
                  <h3 className="text-2xl font-bold">ãƒ¬ãƒ¼ã‚¹è©³ç´°</h3>
                  <button
                    onClick={() => setSelectedRaceDetail(null)}
                    className="text-white hover:bg-white/20 rounded-full w-10 h-10 flex items-center justify-center font-bold text-2xl transition"
                  >
                    Ã—
                  </button>
                </div>
                <div className="text-sm mt-2 opacity-90">ğŸ†” {selectedRaceDetail.raceId}</div>
              </div>

              <div className="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                <div className="mb-4 text-lg font-semibold text-gray-700">
                  å‡ºèµ°é¦¬ä¸€è¦§ <span className="text-blue-600">({selectedRaceDetail.results.length}é ­)</span>
                </div>

                <div className="overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead className="bg-gray-100 sticky top-0">
                      <tr>
                        <th className="px-3 py-3 text-left font-bold text-gray-700">ç€é †</th>
                        <th className="px-3 py-3 text-left font-bold text-gray-700">æ </th>
                        <th className="px-3 py-3 text-left font-bold text-gray-700">é¦¬ç•ª</th>
                        <th className="px-3 py-3 text-left font-bold text-gray-700">é¦¬å</th>
                        <th className="px-3 py-3 text-left font-bold text-gray-700">æ€§é½¢</th>
                        <th className="px-3 py-3 text-left font-bold text-gray-700">æ–¤é‡</th>
                        <th className="px-3 py-3 text-left font-bold text-gray-700">é¨æ‰‹</th>
                        <th className="px-3 py-3 text-left font-bold text-gray-700">ã‚¿ã‚¤ãƒ </th>
                        <th className="px-3 py-3 text-left font-bold text-gray-700">ã‚ªãƒƒã‚º</th>
                        <th className="px-3 py-3 text-left font-bold text-gray-700">äººæ°—</th>
                      </tr>
                    </thead>
                    <tbody>
                      {selectedRaceDetail.results.map((result: any, index: number) => (
                        <tr key={index} className={`border-b hover:bg-blue-50 transition ${
                          result.finish_position === 1 ? 'bg-yellow-50' :
                          result.finish_position === 2 ? 'bg-gray-50' :
                          result.finish_position === 3 ? 'bg-orange-50' : ''
                        }`}>
                          <td className="px-3 py-3 font-bold text-gray-800">
                            {result.finish_position <= 3 && result.finish_position === 1 && 'ğŸ¥‡'}
                            {result.finish_position <= 3 && result.finish_position === 2 && 'ğŸ¥ˆ'}
                            {result.finish_position <= 3 && result.finish_position === 3 && 'ğŸ¥‰'}
                            {result.finish_position}
                          </td>
                          <td className="px-3 py-3">{result.bracket_number}</td>
                          <td className="px-3 py-3 font-semibold">{result.horse_number}</td>
                          <td className="px-3 py-3 font-semibold text-gray-800">{result.horse_name}</td>
                          <td className="px-3 py-3">{result.sex}{result.age}</td>
                          <td className="px-3 py-3">{result.jockey_weight}kg</td>
                          <td className="px-3 py-3">{result.jockey_name}</td>
                          <td className="px-3 py-3 font-mono">{result.finish_time?.toFixed(1)}s</td>
                          <td className="px-3 py-3 font-semibold">{result.odds?.toFixed(1)}</td>
                          <td className="px-3 py-3">{result.popularity}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        )}
      </main>
    </div>
  )
}
