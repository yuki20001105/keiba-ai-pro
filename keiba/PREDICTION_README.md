# 🐎 競馬AI 予測・投票システム

機械学習を使った競馬予測システムです。レースの勝率予測から期待値に基づく馬券選択まで、一連の処理を自動化します。

## ✨ 主な機能

### 1. データ取得（ページ1）
- netkeiba から開催日、レースID、結果を自動取得
- 並列処理による高速化（最大10ワーカー）
- リトライ機能とエラーハンドリング
- 取得状況の可視化

### 2. モデル学習（ページ2）
- 取得したデータから機械学習モデルを構築
- 複数の特徴量を使用した勝率予測

### 3. 予測・投票（ページ3）★ 新機能
- レースIDを入力して勝率を予測
- JRA公式サイトからリアルタイムオッズを取得（Playwright使用）
- 期待値計算による馬券候補の自動選出
- 5つの馬券種に対応：単勝、馬連、馬単、三連複、三連単

## 🎯 システムの特徴

### 期待値ベースの予測
```
期待値 = 的中確率（機械学習予測） × オッズ
```

期待値が1.0を超える馬券を探すことで、長期的な収益を狙います。

### 馬券種ごとの最適閾値
- **単勝**: 期待値 > 1.89 で回収率131%
- **馬連**: 期待値 > 4.11 で回収率162%
- その他の馬券種も調整可能

### シンプルなUI設計
- レースIDを入力するだけで実行
- 進捗状況をリアルタイム表示
- 各馬券種の候補を見やすく表示

## 📋 必要要件

```bash
# Python環境
Python 3.10以上

# 主要ライブラリ
streamlit
pandas
numpy
playwright
scikit-learn
beautifulsoup4
lxml
requests
```

## 🚀 使い方

### 1. 環境のセットアップ

```bash
# 仮想環境の有効化（既存の場合）
cd c:\Users\yuki2\Documents\ws\keiba

# Playwrightのインストール（初回のみ）
python -m playwright install chromium
```

### 2. Streamlit アプリの起動

```bash
# アプリを起動
streamlit run ui_app.py
```

### 3. 予測の実行

1. サイドバーから「3_予測」ページを選択
2. レースIDを入力（例：202505020402）
3. 必要に応じて詳細設定を調整
   - 予測確率の下限
   - 期待値の閾値
   - 購入金額
4. 「▶️ 予測実行」ボタンをクリック

### 4. 結果の確認

- 予測結果サマリ：対象馬数、馬券候補数、最高勝率、総購入金額
- 馬券種ごとの候補：期待値でソートされた購入候補
- 詳細データ：全馬の予測勝率

## 📁 プロジェクト構造

```
keiba/
├── keiba_ai/                # コアモジュール
│   ├── extract_odds.py     # オッズ取得（新規）
│   ├── prediction.py       # 予測・期待値計算（新規）
│   ├── pipeline_daily.py   # 特徴量作成（更新）
│   ├── config.py
│   ├── train.py
│   └── predict.py
├── pages/
│   ├── 1_データ取得.py
│   ├── 2_学習.py
│   └── 3_予測.py           # 予測・投票UI（大幅更新）
├── data/
│   ├── netkeiba/           # スクレイピングデータ
│   └── models/             # 学習済みモデル
├── config.yaml
└── ui_app.py
```

## 🔧 詳細設定

### オッズ取得設定

- **リアルタイムオッズ**: JRA公式サイトから取得（Playwright必須）
- **デモモード**: 模擬オッズで動作確認（デフォルト）

### 期待値閾値

各馬券種ごとに期待値の閾値を設定できます：

- **単勝**: 1.89（推奨）
- **馬単**: 2.0（デフォルト）
- **馬連**: 4.11（推奨）
- **三連複/三連単**: 調整可能

## 📚 参考記事

このシステムは以下の記事を参考に実装されています：

- [競馬AIがついに完成！機械学習による予測から自動投票までの全体構成【#33】](https://note.com/dijzpeb/n/n4b1dca201cc9)

## ⚠️ 注意事項

- このシステムは競馬予想をサポートするためのツールです
- **絶対に勝つことを保証するものではありません**
- 自己責任で利用してください
- 予想が外れる可能性が常に存在します
- 賭博に関する法律を遵守してください
- 過度な依存は避けてください

## 🐛 トラブルシューティング

### Playwrightのエラー

```bash
# ブラウザの再インストール
python -m playwright install --force chromium
```

### モデルが見つからない

先に「2_学習」ページでモデルを学習してください。

### 特徴量作成エラー

レースIDが正しいか確認してください。過去のレースのみ対応しています。

## 📈 今後の拡張予定

- [ ] 自動投票機能の実装（IPAT連携）
- [ ] より高度な特徴量エンジニアリング
- [ ] モデルのアンサンブル学習
- [ ] リアルタイム通知機能
- [ ] 収支管理機能

## 📝 ライセンス

本プロジェクトは研究・学習目的で作成されています。

---

**Happy Betting! 🐴💰**
